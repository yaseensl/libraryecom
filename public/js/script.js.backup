/* ====== FRONTEND JAVASCRIPT  ====== */
console.log("Script.js loaded!");

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM ready");
  
  // Setup header
  setupHeader();
  
  // Check which page we're on
  const path = window.location.pathname;
  console.log("Current page:", path);
  
  // Load books on homepage
  if (path.includes('index.html') || path === '/' || path === '') {
    loadBooks(6);
  }
  
  // Load books on products page
  if (path.includes('products.html')) {
    loadBooks();
  }
  
  // Setup registration form
  const registerForm = document.getElementById('register-form');
  if (registerForm) {
    console.log("Found register form, attaching handler");
    
    registerForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log("REGISTER SUBMIT READY");
      
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      console.log("Form values:", {username, email, passwordLength: password.length});
      
      if (!username || !email || !password || !confirmPassword) {
        alert('Please fill in all fields');
        return;
      }
      
      if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
      }
      
      if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }
      
      try {
        console.log("Sending request to /auth/register...");
        
        const response = await fetch('/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email, password })
        });
        
        console.log("Response status:", response.status);
        
        const data = await response.json();
        console.log("Response data:", data);
        
        if (response.ok) {
          alert('Account created successfully!');
          window.location.href = 'index.html';
        } else {
          alert(data.error || 'Registration failed');
        }
      } catch (error) {
        console.error("Error:", error);
        alert('An error occurred: ' + error.message);
      }
    });
  } else {
    console.log("No register form on this page");
  }
  
  // Setup login form
  const loginForm = document.getElementById('login-form');
  if (loginForm) {
    console.log("Found login form, attaching handler");
    
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      console.log("LOGIN SUBMIT FIRED!");
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      console.log("Login attempt for:", email);
      
      if (!email || !password) {
        alert('Please fill in all fields');
        return;
      }
      
      try {
        console.log("Sending request to /auth/login...");
        
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        console.log("Response status:", response.status);
        
        const data = await response.json();
        console.log("Response data:", data);
        
        if (response.ok) {
          alert('Logged in successfully!');
          window.location.href = 'index.html';
        } else {
          alert(data.error || 'Login failed');
        }
      } catch (error) {
        console.error("Error:", error);
        alert('An error occurred: ' + error.message);
      }
    });
  } else {
    console.log("No login form on this page");
  }
});

// Helper functions
async function setupHeader() {
  try {
    const response = await fetch('/auth/current-user');
    const data = await response.json();
    
    const loginLink = document.getElementById('login-link');
    const logoutContainer = document.getElementById('logout-container');
    
    if (data.user) {
      // Hide login link
      if (loginLink) {
        loginLink.style.display = 'none';
        loginLink.classList.add('hidden');
      }
      
      // Create logout icon button
      if (logoutContainer) {
        logoutContainer.innerHTML = '';
        const logoutBtn = document.createElement('button');
        logoutBtn.id = 'logout-btn';
        logoutBtn.setAttribute('data-username', data.user.username);
        logoutBtn.innerHTML = '<span class="logout-text">ðŸ‘¤</span>';
        logoutContainer.appendChild(logoutBtn);
        
        logoutBtn.addEventListener('click', async function() {
          if (confirm('Are you sure you want to logout?')) {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = 'index.html';
          }
        });
      }
    } else {
      // Show login link when not logged in
      if (loginLink) {
        loginLink.style.display = 'inline';
        loginLink.classList.remove('hidden');
      }
      if (logoutContainer) {
        logoutContainer.innerHTML = '';
      }
    }
  } catch (error) {
    console.error('Error setting up header:', error);
  }
}

async function loadBooks(limit) {
  const bookList = document.querySelector('.book-list');
  if (!bookList) return;
  
  try {
    const response = await fetch('/books');
    const books = await response.json();
    
    const booksToShow = limit ? books.slice(0, limit) : books;
    
    bookList.innerHTML = booksToShow.map(book => `
      <div class="item">
        <a href="book.html?id=${book.book_id}">
          <img src="img/${book.image_url}" alt="${book.title}" />
          <h3>${book.title}</h3>
          <p>by ${book.author}</p>
          <p class="book-price">$${parseFloat(book.price).toFixed(2)}</p>
        </a>
      </div>
    `).join('');
  } catch (error) {
    console.error('Error loading books:', error);
  }
}
